<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>為替変換分析ツール</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    input, button {
      margin: 5px;
      padding: 5px;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    h2 {
      margin-top: 40px;
    }
    .summary {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>為替変換分析ツール</h1>

  <!-- USD → JPY -->
  <h2>米ドル → 日本円</h2>
  <table id="usdToJpyTable">
    <tr><th>米ドル金額</th><th>米ドル→円レート</th><th>換算後の円</th><th>操作</th></tr>
    <tr>
      <td><input type="number" class="usdAmount" oninput="autoCalc(this, 'usdToJpy')"></td>
      <td><input type="number" class="usdToJpyRate" oninput="autoCalc(this, 'usdToJpy')"></td>
      <td class="usdToJpyResult">--</td>
      <td><button onclick="removeRow(this)">削除</button></td>
    </tr>
  </table>
  <button onclick="addRow('usdToJpyTable', ['usdAmount', 'usdToJpyRate'], 'usdToJpyResult', 'usdToJpy')">➕ 行を追加</button>

  <!-- JPY → USD -->
  <h2>日本円 → 米ドル</h2>
  <table id="jpyToUsdTable">
    <tr><th>円金額</th><th>円→米ドルレート</th><th>換算後の米ドル</th><th>操作</th></tr>
    <tr>
      <td><input type="number" class="jpyAmount" oninput="autoCalc(this, 'jpyToUsd')"></td>
      <td><input type="number" class="jpyToUsdRate" oninput="autoCalc(this, 'jpyToUsd')"></td>
      <td class="jpyToUsdResult">--</td>
      <td><button onclick="removeRow(this)">削除</button></td>
    </tr>
  </table>
  <button onclick="addRow('jpyToUsdTable', ['jpyAmount', 'jpyToUsdRate'], 'jpyToUsdResult', 'jpyToUsd')">➕ 行を追加</button>

  <br><button onclick="calculateSummary()">📊 集計する</button>

  <div class="summary" id="summaryResult"></div>

  <script>
    function cleanNumber(num) {
      return (Object.is(num, -0) || Math.abs(num) < 0.00001) ? 0 : num;
    }

    function formatNumber(num) {
      const cleaned = cleanNumber(num);
      return cleaned.toLocaleString('ja-JP', { maximumFractionDigits: 2 });
    }

    function formatYield(num) {
      const cleaned = cleanNumber(num);
      return cleaned === 0 ? '--' : `${cleaned.toFixed(2)}%`;
    }

    function addRow(tableId, inputClasses, resultClass, type) {
      const table = document.getElementById(tableId);
      const row = table.insertRow();
      inputClasses.forEach(cls => {
        const cell = row.insertCell();
        const input = document.createElement('input');
        input.type = 'number';
        input.className = cls;
        input.setAttribute('oninput', `autoCalc(this, '${type}')`);
        cell.appendChild(input);
      });
      const resultCell = row.insertCell();
      resultCell.className = resultClass;
      resultCell.textContent = '--';
      const actionCell = row.insertCell();
      actionCell.innerHTML = `<button onclick="removeRow(this)">削除</button>`;
    }

    function removeRow(btn) {
      const row = btn.parentNode.parentNode;
      row.parentNode.removeChild(row);
    }

    function autoCalc(input, type) {
      const row = input.closest('tr');
      let amount, rate, result;
      if (type === 'usdToJpy') {
        amount = parseFloat(row.querySelector('.usdAmount')?.value);
        rate = parseFloat(row.querySelector('.usdToJpyRate')?.value);
        result = amount * rate;
        row.querySelector('.usdToJpyResult').textContent = isNaN(result) ? '--' : formatNumber(result);
      } else if (type === 'jpyToUsd') {
        amount = parseFloat(row.querySelector('.jpyAmount')?.value);
        rate = parseFloat(row.querySelector('.jpyToUsdRate')?.value);
        result = amount / rate;
        row.querySelector('.jpyToUsdResult').textContent = isNaN(result) ? '--' : formatNumber(result);
      }
    }

    function calculateSummary() {
      let usdTotal = 0, jpyFromUsdTotal = 0;
      let jpyTotal = 0, usdFromJpyTotal = 0;

      document.querySelectorAll('#usdToJpyTable tr').forEach(row => {
        const usdInput = row.querySelector('.usdAmount');
        const rateInput = row.querySelector('.usdToJpyRate');
        if (usdInput && rateInput) {
          const usd = parseFloat(usdInput.value);
          const rate = parseFloat(rateInput.value);
          if (!isNaN(usd) && !isNaN(rate)) {
            const jpy = usd * rate;
            row.querySelector('.usdToJpyResult').textContent = formatNumber(jpy);
            usdTotal += usd;
            jpyFromUsdTotal += jpy;
          }
        }
      });

      document.querySelectorAll('#jpyToUsdTable tr').forEach(row => {
        const jpyInput = row.querySelector('.jpyAmount');
        const rateInput = row.querySelector('.jpyToUsdRate');
        if (jpyInput && rateInput) {
          const jpy = parseFloat(jpyInput.value);
          const rate = parseFloat(rateInput.value);
          if (!isNaN(jpy) && !isNaN(rate)) {
            const usd = jpy / rate;
            row.querySelector('.jpyToUsdResult').textContent = formatNumber(usd);
            jpyTotal += jpy;
            usdFromJpyTotal += usd;
          }
        }
      });

      const usdProfit = usdFromJpyTotal - usdTotal;
      const usdYield = usdTotal > 0 ? (usdProfit / usdTotal) * 100 : 0;

      const jpyProfit = jpyFromUsdTotal - jpyTotal;
      const jpyYield = jpyTotal > 0 ? (jpyProfit / jpyTotal) * 100 : 0;

      document.getElementById('summaryResult').innerHTML = `
        <h3>📈 集計結果</h3>
        <table>
          <tr><th>経路</th><th>変換前金額</th><th>変換後金額</th><th>差額</th><th>収益率</th></tr>
          <tr>
            <td>米ドル → 円 → 米ドル</td>
            <td>${formatNumber(usdTotal)} USD</td>
            <td>${formatNumber(usdFromJpyTotal)} USD</td>
            <td>${formatNumber(usdProfit)} USD</td>
            <td>${formatYield(usdYield)}</td>
          </tr>
          <tr>
            <td>円 → 米ドル → 円</td>
            <td>${formatNumber(jpyTotal)} 円</td>
            <td>${formatNumber(jpyFromUsdTotal)} 円</td>
            <td>${formatNumber(jpyProfit)} 円</td>
            <td>${formatYield(jpyYield)}</td>
          </tr>
        </table>
      `;
    }
  </script>
</body>
</html>
